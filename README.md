# Backend для хакатона осень 2025

## Описание

Клиентское приложение посылает запрос на глобальный бек, глобальный бек получается ip адрес клиента, далее выбирается режим работы:
- если broadcast true, то запрос посылается на всех агентов, и ответы соответственно будут от каждого агента к запрашиваемому хосту
- если broadcast false, то по ip адресу клиента вычисляется его примерное местоположение с помощью MaxMind DB базы данных (база данных с геолокационными данными по IP-адресам), и направляется запрос к ближайшему агенту, чтобы минимизировать задержку между клиентом и запрашиваемым хостом

Далее запрос падает в очередь (Kafka) в топик по каждому региону агентов, система предусматривает, что в каждом регионе может быть некоторое число агентов, которые делают необходимые, запрашиваемые пользователем проверки и кладут результат обратно в очередь к глобальному беку
На глобальном беке сразу после запроса доступен websocket, в который как данные приходят по очереди обработки, пользователю сразу направляется результат выполнения его запроса по типу (например сначала обработался Ping, потом DNS - и пользователь сразу может увидеть результат Ping, не дожидаясь ответа от DNS или traceroute)
Также в ответе traceroute пользователю возвращаются координаты точек, c помощью которых UI строит маршрут запроса на карте.

Также реализованы JWT-авторизация, CRUD пользователей, админская часть и блог, в который будут добавляться описания нововведений сервиса
Также в архитектуре проекта был применён паттерн inbox/outbox, чтобы не терять сообщения из kafka

Используемые технологии:
- Go
- Kafka
- Docker
- Redis
- Postgres
- Elasticsearch
- GeoLite2 DB

## Добавление агента на сервер

Для добавления агента используется docker образ, который тянется с docker registry,
Необходимо подтянуть образ и составить config.yml файл, который должен содержать следующие поля:

```yaml
app:
  agent_id: "6d40a8b9-a135-4b67-b96b-0579c6ae0f76" # uuid агента
  region: "GL" # регион агента
subscriber:
  brokers:
    - "127.0.0.1:9092"
  group_id: "1"
  topic: "hosts-check-GL" # топик, откуда агент читает
  buffer_size: 1000
publisher:
  brokers:
    - "127.0.0.1:9092"
  topic: "hosts-checked"  # топик, куда агент посылает данные
```

Никаких других зависимостей агент не требует, максимально лёгкий cli демон
Конфиг передаётся при запуске или через переменные окружения

## Запуск

### Запуск для разработчика (конфиг по дефолту [config.template.yml](config/config.template.yml))
```bash
# Запускаем зависимые сервисы
docker compose -f docker-compose.dev.yml up -d

# Генерируем .pem ключи
task keygen

# Запуск приложения
task run
```

### Запуск для фронтендера (конфиг по дефолту [config.docker.yml](config/config.docker.yml))

```bash
# Клонируем репозиторий
git clone https://sourcecraft.dev/blue-screen/backend

# Переходим в директорию проекта
cd hackathon-back

# Создаём подсеть докера
docker network create my-shared-net

# Запускаем в Docker и всё
docker compose up -d --build

# Можно потыкать конфиги, но это не рекомендуется
```

## Использование при локальном запуске

- Документация находится по адресу: http://localhost:8080/api/docs/swagger/index.html
- Тестовый smtp сервер: http://localhost:8025
- Базовый путь /api
- Дефолтный manager: "email": "manager@gmail.com", "password": "12345678"

## Общие рекомендации по разработке

1. Внимательно прочитай Taskfile. Используй task, чтобы посмотреть доступные команды.
2. Для создания новой миграции используй task migrate-create.
3. Форматируй проект.
4. Запускай почаще линтеры и исправляй ошибки, ими найденные.
5. Если обновил что-то в swagger документации, то вызывай task swagger, чтобы подтянуть изменения
